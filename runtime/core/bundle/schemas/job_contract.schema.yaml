# RoboZilla Job Contract Schema
#
# This is a JSON Schema (Draft 2020-12) expressed as YAML.
#
# A JobContract defines how work is requested, executed, evaluated, and
# terminated. It is the boundary that prevents runaway execution.
#
# Key properties:
# - Organization-scoped (sellable unit boundary)
# - Immutable after creation except for status updates
# - Explicit permissions snapshot for deterministic enforcement
# - Explicit limits and stop conditions for deterministic termination
#
$schema: https://json-schema.org/draft/2020-12/schema
$id: https://robozilla.ai/schemas/job_contract.schema.yaml
title: RoboZilla Job Contract
description: >-
  Work authorization and execution boundary for a single job. Jobs are governed
  by explicit permissions, limits, stop conditions, and evaluations. Flo enforces
  the contract; agents cannot bypass it.
type: object
additionalProperties: false
required:
  - api_version
  - kind
  - metadata
  - spec
properties:
  api_version:
    type: string
    const: robozilla.ai/v1alpha1
    description: Document structure version.
  kind:
    type: string
    const: JobContract
    description: Document type discriminator.
  metadata:
    $ref: '#/$defs/metadata'
  spec:
    $ref: '#/$defs/spec'

allOf:
  # Completed or failed jobs must be linked to an evaluation (only evaluations can complete jobs).
  - if:
      properties:
        spec:
          properties:
            status:
              properties:
                state:
                  enum: [completed, failed]
    then:
      properties:
        spec:
          properties:
            status:
              required:
                - final_evaluation_ref
                - terminal_at

  # Failed jobs must declare an explicit failure mode.
  - if:
      properties:
        spec:
          properties:
            status:
              properties:
                state:
                  const: failed
    then:
      properties:
        spec:
          properties:
            status:
              required:
                - failure_mode

  # Expired jobs must include terminal_at and an expiry reason.
  - if:
      properties:
        spec:
          properties:
            status:
              properties:
                state:
                  const: expired
    then:
      properties:
        spec:
          properties:
            status:
              required:
                - terminal_at
                - expiry_reason

$defs:
  # --------
  # Primitives
  # --------
  org_id:
    type: string
    minLength: 3
    maxLength: 64
    pattern: '^[a-z](?:[a-z0-9-]{1,62}[a-z0-9])$'

  id_token:
    type: string
    minLength: 2
    maxLength: 64
    pattern: '^[a-z](?:[a-z0-9_.-]{0,62}[a-z0-9])$'

  job_id:
    type: string
    minLength: 1
    maxLength: 128
    pattern: '^[A-Za-z0-9][A-Za-z0-9_.:-]{0,127}$'
    description: Stable job identifier.

  uri_reference:
    type: string
    minLength: 1
    maxLength: 2048
    format: uri-reference

  date_time:
    type: string
    format: date-time
    maxLength: 64

  non_negative_int:
    type: integer
    minimum: 0
    maximum: 1000000000

  positive_int:
    type: integer
    minimum: 1
    maximum: 1000000000

  money_amount:
    type: number
    minimum: 0

  confidence:
    type: number
    minimum: 0
    maximum: 1

  authority_level:
    type: string
    enum: [worker, org_lead, evaluator]

  # Canonical platform artifact categories (coarse). Domain-specific validation
  # happens via schema_ref and content schemas elsewhere.
  artifact_type:
    type: string
    enum:
      - report
      - plan
      - dataset
      - message
      - decision_record
      - evidence
      - diagnostic
      - workflow_definition
      - other

  # --------
  # Top-level blocks
  # --------
  metadata:
    type: object
    additionalProperties: false
    required:
      - job_id
      - org_id
    properties:
      job_id:
        $ref: '#/$defs/job_id'
      org_id:
        $ref: '#/$defs/org_id'
      title:
        type: string
        maxLength: 200
        description: Optional short title (human-friendly).
      tags:
        type: array
        description: Deterministic retrieval tags (stable tokens).
        items:
          $ref: '#/$defs/id_token'

  spec:
    type: object
    additionalProperties: false
    required:
      - requested_by
      - goal
      - required_artifacts
      - permissions_snapshot
      - execution_limits
      - stop_conditions
      - escalation
      - timestamps
      - status
      - invariants
    properties:
      requested_by:
        $ref: '#/$defs/actor_ref'
      goal:
        type: string
        minLength: 1
        maxLength: 4000
        description: Human-readable goal statement for the job.
      required_artifacts:
        type: array
        description: >-
          Required artifact outputs for this job, expressed as coarse artifact
          categories plus schema references for validation.
        items:
          $ref: '#/$defs/required_artifact'
      permissions_snapshot:
        $ref: '#/$defs/permissions_snapshot'
      execution_limits:
        $ref: '#/$defs/execution_limits'
      stop_conditions:
        type: array
        minItems: 1
        description: Explicit stop conditions (enumerable) for deterministic termination.
        items:
          $ref: '#/$defs/stop_condition'
      escalation:
        $ref: '#/$defs/escalation'
      timestamps:
        $ref: '#/$defs/timestamps'
      status:
        $ref: '#/$defs/status'
      invariants:
        $ref: '#/$defs/invariants'
      notes:
        type: string
        maxLength: 4000

  # --------
  # Actors
  # --------
  actor_ref:
    type: object
    additionalProperties: false
    required:
      - actor_type
      - actor_id
      - authority_level
    properties:
      actor_type:
        type: string
        enum: [agent, human, system]
      actor_id:
        type: string
        minLength: 1
        maxLength: 256
      authority_level:
        $ref: '#/$defs/authority_level'
      confidence:
        $ref: '#/$defs/confidence'
        description: Optional confidence in the request (when actor is system/agent).
      notes:
        type: string
        maxLength: 1000

  # --------
  # Required artifacts
  # --------
  required_artifact:
    type: object
    additionalProperties: false
    required:
      - artifact_type
      - schema_ref
    properties:
      artifact_type:
        $ref: '#/$defs/artifact_type'
      schema_ref:
        $ref: '#/$defs/uri_reference'
        description: Reference to the artifact schema/contract expected.
      min_count:
        $ref: '#/$defs/positive_int'
        description: Minimum number of artifacts of this type required (default 1).
      description:
        type: string
        maxLength: 1000
      acceptance_notes:
        type: string
        maxLength: 2000

  # --------
  # Permissions snapshot
  # --------
  permissions_snapshot:
    type: object
    additionalProperties: false
    required:
      - skills
      - mcp
      - direct_external_network
    description: >-
      Immutable snapshot of allowed capabilities for this job. This is evaluated
      by Flo at runtime and should be the effective intersection of org and agent
      policies.
    properties:
      skills:
        type: object
        additionalProperties: false
        required:
          - allowed_skill_ids
          - allowed_skill_categories
        properties:
          allowed_skill_ids:
            type: array
            description: Explicit allowlist of skill identifiers for this job.
            items:
              $ref: '#/$defs/id_token'
          allowed_skill_categories:
            type: array
            description: Allowlist of skill categories for this job.
            items:
              $ref: '#/$defs/id_token'
      mcp:
        type: object
        additionalProperties: false
        required:
          - allowed
        properties:
          allowed:
            type: array
            description: Allowlist of MCP gateways this job may use (default empty).
            items:
              $ref: '#/$defs/mcp_ref'
      direct_external_network:
        type: object
        additionalProperties: false
        required:
          - policy
        description: >-
          Direct outbound network access policy for this job. Prefer MCP.
        properties:
          policy:
            type: string
            enum: [deny_all, allowlist]
          allowlist:
            $ref: '#/$defs/network_allowlist'
          denylist:
            $ref: '#/$defs/network_denylist'
    allOf:
      - if:
          properties:
            direct_external_network:
              properties:
                policy:
                  const: allowlist
        then:
          properties:
            direct_external_network:
              required:
                - allowlist

  mcp_ref:
    type: object
    additionalProperties: false
    required:
      - mcp_id
      - ref
    properties:
      mcp_id:
        $ref: '#/$defs/id_token'
      ref:
        $ref: '#/$defs/uri_reference'
      allowed_scopes:
        type: array
        items:
          type: string
          minLength: 1
          maxLength: 128

  network_allowlist:
    type: object
    additionalProperties: false
    properties:
      domains:
        type: array
        items:
          type: string
          minLength: 1
          maxLength: 253
          pattern: '^(?:\\*\\.)?[A-Za-z0-9-]+(?:\\.[A-Za-z0-9-]+)+$'
      urls:
        type: array
        items:
          type: string
          format: uri
          maxLength: 2048
      ip_cidrs:
        type: array
        items:
          type: string
          minLength: 1
          maxLength: 64
          pattern: '^[0-9A-Fa-f:.]+\\/[0-9]{1,3}$'

  network_denylist:
    type: object
    additionalProperties: false
    properties:
      domains:
        type: array
        items:
          type: string
          minLength: 1
          maxLength: 253
          pattern: '^(?:\\*\\.)?[A-Za-z0-9-]+(?:\\.[A-Za-z0-9-]+)+$'
      urls:
        type: array
        items:
          type: string
          format: uri
          maxLength: 2048
      ip_cidrs:
        type: array
        items:
          type: string
          minLength: 1
          maxLength: 64
          pattern: '^[0-9A-Fa-f:.]+\\/[0-9]{1,3}$'

  # --------
  # Limits and stop conditions
  # --------
  execution_limits:
    type: object
    additionalProperties: false
    required:
      - max_iterations
      - max_runtime_seconds
      - cost_cap
    properties:
      max_iterations:
        $ref: '#/$defs/positive_int'
        description: Hard cap on orchestrator iterations/turns for this job.
      max_runtime_seconds:
        $ref: '#/$defs/positive_int'
        description: Hard cap on wall-clock runtime for this job.
      cost_cap:
        type: object
        additionalProperties: false
        required:
          - currency
          - max_cost
        description: Generic cost cap (does not assume any provider billing unit).
        properties:
          currency:
            type: string
            pattern: '^[A-Z]{3}$'
            description: ISO 4217 currency code (e.g., "USD").
          max_cost:
            $ref: '#/$defs/money_amount'

  stop_condition:
    type: object
    additionalProperties: false
    required:
      - condition_type
    properties:
      condition_type:
        type: string
        enum:
          - goal_achieved
          - evaluation_passed
          - evaluation_failed
          - max_iterations_reached
          - max_runtime_reached
          - cost_cap_reached
          - expires_at_reached
          - constraint_violation
          - manual_stop
          - no_progress
          - dependency_unavailable
          - missing_required_artifacts
      description:
        type: string
        maxLength: 1000
      enforcement:
        type: string
        enum: [hard, soft]
        default: hard

  # --------
  # Escalation
  # --------
  escalation:
    type: object
    additionalProperties: false
    required:
      - default_target
    properties:
      default_target:
        $ref: '#/$defs/escalation_target'
      rules:
        type: array
        description: Optional ordered escalation rules (first match wins).
        items:
          $ref: '#/$defs/escalation_rule'
      notes:
        type: string
        maxLength: 2000

  escalation_target:
    type: object
    additionalProperties: false
    required:
      - target_type
    properties:
      target_type:
        type: string
        enum: [authority_level, agent_id, human, system]
      authority_level:
        type: string
        enum: [org_lead, evaluator]
      agent_id:
        type: string
        minLength: 3
        maxLength: 64
        pattern: '^[a-z](?:[a-z0-9-]{1,62}[a-z0-9])$'
      human_id:
        type: string
        minLength: 1
        maxLength: 256
      system_id:
        type: string
        minLength: 1
        maxLength: 256
      notes:
        type: string
        maxLength: 1000
    allOf:
      - if:
          properties:
            target_type:
              const: authority_level
        then:
          required: [authority_level]
      - if:
          properties:
            target_type:
              const: agent_id
        then:
          required: [agent_id]
      - if:
          properties:
            target_type:
              const: human
        then:
          required: [human_id]
      - if:
          properties:
            target_type:
              const: system
        then:
          required: [system_id]

  escalation_rule:
    type: object
    additionalProperties: false
    required:
      - when
      - target
    properties:
      rule_id:
        $ref: '#/$defs/id_token'
      when:
        type: array
        minItems: 1
        description: Trigger identifiers (implementation-defined).
        items:
          $ref: '#/$defs/id_token'
      target:
        $ref: '#/$defs/escalation_target'
      urgency:
        type: string
        enum: [low, normal, high]
      notes:
        type: string
        maxLength: 2000

  # --------
  # Timestamps and lifecycle
  # --------
  timestamps:
    type: object
    additionalProperties: false
    required:
      - created_at
      - expires_at
    properties:
      created_at:
        $ref: '#/$defs/date_time'
      expires_at:
        $ref: '#/$defs/date_time'

  status:
    type: object
    additionalProperties: false
    required:
      - state
      - status_updated_at
    description: >-
      The only mutable portion of the JobContract. All other fields are
      immutable after creation.
    properties:
      state:
        type: string
        enum: [created, running, waiting, completed, failed, expired]
      status_updated_at:
        $ref: '#/$defs/date_time'
      started_at:
        $ref: '#/$defs/date_time'
      terminal_at:
        $ref: '#/$defs/date_time'
      final_evaluation_ref:
        $ref: '#/$defs/uri_reference'
        description: Required when state is completed or failed.
      failure_mode:
        type: string
        enum: [timeout, constraint_violation, evaluation_failure, stop_condition, unknown]
        description: Required when state is failed.
      failure_details:
        type: string
        maxLength: 4000
      expiry_reason:
        type: string
        enum: [expires_at_reached, max_runtime_reached, manual_expire, unknown]
      last_stop_condition:
        $ref: '#/$defs/id_token'
        description: Optional identifier of the stop condition that triggered termination.

  # --------
  # Invariants (constants)
  # --------
  invariants:
    type: object
    additionalProperties: false
    required:
      - no_side_effects_without_active_job_contract
      - immutable_after_creation_except_status
      - flo_enforced
    description: Platform-level invariants enforced as constants.
    properties:
      no_side_effects_without_active_job_contract:
        type: boolean
        const: true
        description: Side effects require an active job contract at runtime.
      immutable_after_creation_except_status:
        type: boolean
        const: true
      flo_enforced:
        type: boolean
        const: true
        description: Flo enforces contracts; agents cannot bypass enforcement.
