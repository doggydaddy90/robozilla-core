# RoboZilla Memory Entry Schema
#
# This is a JSON Schema (Draft 2020-12) expressed as YAML.
#
# Memory is ALL persistent knowledge used by RoboZilla agents. Memory is:
# - Structured: validated fields, not raw documents.
# - Scoped: always owned by exactly one organization.
# - Governed: draft vs authoritative, promotion rules, retention, mutability.
#
# Non-goals:
# - Raw documents, transcripts, PDFs, and websites are NOT memory.
# - This schema does not define Job/Artifact/Evaluation contracts; it only references them.
#
$schema: https://json-schema.org/draft/2020-12/schema
$id: https://robozilla.ai/schemas/memory_entry.schema.yaml
title: RoboZilla Memory Entry
description: >-
  Structured persistent knowledge entry for an organization. Entries are
  governed (draft/authoritative), access-controlled, versioned, and retained per
  explicit policy. Retrieval is deterministic by org_id, memory_type, tags, and
  agent role/identity filters.
type: object
additionalProperties: false
required:
  - api_version
  - kind
  - metadata
  - spec
properties:
  api_version:
    type: string
    const: robozilla.ai/v1alpha1
    description: Document structure version (not the content's authority state).
  kind:
    type: string
    const: MemoryEntry
    description: Document type discriminator.
  metadata:
    $ref: '#/$defs/metadata'
  spec:
    $ref: '#/$defs/spec'

allOf:
  # Notes are intentionally low-authority: they cannot be authoritative.
  - if:
      properties:
        metadata:
          properties:
            memory_type:
              const: notes
    then:
      properties:
        spec:
          properties:
            governance:
              properties:
                status:
                  enum: [draft, archived]

  # Workers may NOT write facts or procedures directly (creation must be org_lead/evaluator).
  - if:
      properties:
        metadata:
          properties:
            memory_type:
              enum: [facts, procedures]
    then:
      properties:
        spec:
          properties:
            provenance:
              properties:
                created_by:
                  properties:
                    authority_level:
                      enum: [org_lead, evaluator]
            access:
              properties:
                write:
                  properties:
                    min_authority_level:
                      enum: [org_lead, evaluator]

  # Each memory_type selects a strict content schema.
  - if:
      properties:
        metadata:
          properties:
            memory_type:
              const: facts
    then:
      properties:
        spec:
          properties:
            content:
              $ref: '#/$defs/content_facts'
  - if:
      properties:
        metadata:
          properties:
            memory_type:
              const: procedures
    then:
      properties:
        spec:
          properties:
            content:
              $ref: '#/$defs/content_procedures'
  - if:
      properties:
        metadata:
          properties:
            memory_type:
              const: templates
    then:
      properties:
        spec:
          properties:
            content:
              $ref: '#/$defs/content_templates'
  - if:
      properties:
        metadata:
          properties:
            memory_type:
              const: examples
    then:
      properties:
        spec:
          properties:
            content:
              $ref: '#/$defs/content_examples'
  - if:
      properties:
        metadata:
          properties:
            memory_type:
              const: decisions
    then:
      properties:
        spec:
          properties:
            content:
              $ref: '#/$defs/content_decisions'
  - if:
      properties:
        metadata:
          properties:
            memory_type:
              const: artifacts
    then:
      properties:
        spec:
          properties:
            content:
              $ref: '#/$defs/content_artifacts'
  - if:
      properties:
        metadata:
          properties:
            memory_type:
              const: notes
    then:
      properties:
        spec:
          properties:
            content:
              $ref: '#/$defs/content_notes'

$defs:
  # --------
  # Primitives
  # --------
  org_id:
    type: string
    minLength: 3
    maxLength: 64
    pattern: '^[a-z](?:[a-z0-9-]{1,62}[a-z0-9])$'
    description: Stable, globally unique organization identifier (tenant key).

  id_token:
    type: string
    minLength: 2
    maxLength: 64
    pattern: '^[a-z](?:[a-z0-9_.-]{0,62}[a-z0-9])$'
    description: Stable identifier token.

  memory_id:
    type: string
    minLength: 3
    maxLength: 128
    pattern: '^[a-z][a-z0-9_.:-]{1,127}$'
    description: Stable identifier for a memory entry.

  uri_reference:
    type: string
    minLength: 1
    maxLength: 2048
    format: uri-reference
    description: URI reference resolvable by tooling (relative path or URL).

  date_time:
    type: string
    format: date-time
    maxLength: 64

  semver:
    type: string
    minLength: 1
    maxLength: 64
    pattern: '^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$'
    description: Semantic Version (SemVer 2.0.0).

  non_negative_int:
    type: integer
    minimum: 0
    maximum: 1000000000

  positive_int:
    type: integer
    minimum: 1
    maximum: 1000000000

  confidence:
    type: number
    minimum: 0
    maximum: 1
    description: Confidence score in [0,1] for the memory's accuracy/usefulness.

  authority_level:
    type: string
    enum: [worker, org_lead, evaluator]
    description: Governance authority level (used for write and promotion constraints).

  memory_type:
    type: string
    enum: [facts, procedures, templates, examples, decisions, artifacts, notes]
    description: Memory category/type.

  # --------
  # Top-level blocks
  # --------
  metadata:
    type: object
    additionalProperties: false
    required:
      - memory_id
      - memory_type
      - org_id
      - title
    properties:
      memory_id:
        $ref: '#/$defs/memory_id'
      memory_type:
        $ref: '#/$defs/memory_type'
      org_id:
        $ref: '#/$defs/org_id'
      title:
        type: string
        minLength: 1
        maxLength: 200
        description: Short human-friendly title for this entry.
      summary:
        type: string
        maxLength: 2000
        description: Optional short summary (human-readable).
      tags:
        type: array
        description: Deterministic retrieval tags (stable, lowercase tokens).
        items:
          $ref: '#/$defs/id_token'
      external_ids:
        type: object
        description: Optional mapping to external identifiers (for import/export).
        propertyNames:
          pattern: '^[A-Za-z0-9_.-]{1,64}$'
        additionalProperties:
          type: string
          maxLength: 256

  spec:
    type: object
    additionalProperties: false
    required:
      - content
      - provenance
      - governance
      - access
      - versioning
      - timestamps
      - retention
      - mutability
      - invariants
    properties:
      content:
        description: Type-specific content. Selected by metadata.memory_type.
        type: object
      provenance:
        $ref: '#/$defs/provenance'
      governance:
        $ref: '#/$defs/governance'
      access:
        $ref: '#/$defs/access'
      versioning:
        $ref: '#/$defs/versioning'
      timestamps:
        $ref: '#/$defs/timestamps'
      retention:
        $ref: '#/$defs/retention'
      mutability:
        $ref: '#/$defs/mutability'
      structure:
        $ref: '#/$defs/structure'
      invariants:
        $ref: '#/$defs/invariants'
      notes:
        type: string
        maxLength: 4000
        description: Optional notes for humans (no runtime semantics).

  # --------
  # Provenance
  # --------
  provenance:
    type: object
    additionalProperties: false
    required:
      - method
      - created_by
      - sources
    description: >-
      How this memory was created. Sources are always references; raw source
      material must not be embedded in memory entries.
    properties:
      method:
        type: string
        enum: [human_entry, skill_output, job_artifact, imported, summarized, extracted, decided]
        description: Creation method (high-level, vendor-neutral).
      created_by:
        $ref: '#/$defs/actor_ref'
      sources:
        type: array
        minItems: 1
        description: References to originals used to create this memory entry (no raw content).
        items:
          $ref: '#/$defs/source_ref'
      derived_from_memory_ids:
        type: array
        description: Optional lineage references to prior memory entries (summaries/chunks/updates).
        items:
          $ref: '#/$defs/memory_id'
      tools_used:
        type: array
        description: Optional list of skill identifiers used in creation (for auditability).
        items:
          $ref: '#/$defs/id_token'
      created_under_job:
        $ref: '#/$defs/job_ref'
        description: Optional job reference under which this memory was created.
    allOf:
      - if:
          properties:
            created_by:
              properties:
                actor_type:
                  const: agent
        then:
          required:
            - created_under_job

  actor_ref:
    type: object
    additionalProperties: false
    required:
      - actor_type
      - actor_id
      - authority_level
    properties:
      actor_type:
        type: string
        enum: [agent, human, system]
      actor_id:
        type: string
        minLength: 1
        maxLength: 256
        description: Identifier for the actor (agent_id, human id, or system id).
      authority_level:
        $ref: '#/$defs/authority_level'
      notes:
        type: string
        maxLength: 1000

  source_ref:
    type: object
    additionalProperties: false
    required:
      - source_type
      - ref
    properties:
      source_type:
        type: string
        enum: [artifact, evaluation, job, external_uri, other]
        description: High-level source type.
      ref:
        $ref: '#/$defs/uri_reference'
        description: URI reference to the source record (artifact/job/evaluation/external).
      digest:
        type: string
        maxLength: 128
        description: Optional content digest of the source (e.g., sha256:...).
      excerpt_note:
        type: string
        maxLength: 500
        description: Optional note describing what part of the source was used (no raw text).

  job_ref:
    type: object
    additionalProperties: false
    required:
      - ref
    properties:
      ref:
        $ref: '#/$defs/uri_reference'
      notes:
        type: string
        maxLength: 1000

  # --------
  # Governance (draft/authoritative + promotion rules)
  # --------
  governance:
    type: object
    additionalProperties: false
    required:
      - status
      - confidence
    properties:
      status:
        type: string
        enum: [draft, authoritative, deprecated, archived]
        description: Authority state of this memory entry.
      confidence:
        $ref: '#/$defs/confidence'
      promotion:
        $ref: '#/$defs/promotion'
      notes:
        type: string
        maxLength: 2000
    allOf:
      - if:
          properties:
            status:
              const: authoritative
        then:
          required:
            - promotion

  promotion:
    type: object
    additionalProperties: false
    required:
      - promoted_at
      - promoted_by
      - evaluation_ref
    description: >-
      Promotion record. Promotion to authoritative requires an Evaluation result
      (referenced here) and must be performed by org_lead or evaluator.
    properties:
      promoted_at:
        $ref: '#/$defs/date_time'
      promoted_by:
        $ref: '#/$defs/actor_ref'
      evaluation_ref:
        $ref: '#/$defs/uri_reference'
        description: Reference to an Evaluation result (defined elsewhere).
      notes:
        type: string
        maxLength: 2000
    allOf:
      - properties:
          promoted_by:
            properties:
              authority_level:
                enum: [org_lead, evaluator]

  # --------
  # Access control
  # --------
  access:
    type: object
    additionalProperties: false
    required:
      - read
      - write
    description: >-
      Agent access controls. Memory is always organization-scoped; these rules
      further restrict which agents (by id/role) may read or write.
    properties:
      read:
        $ref: '#/$defs/access_rule'
      write:
        $ref: '#/$defs/access_rule'

  access_rule:
    type: object
    additionalProperties: false
    required:
      - mode
      - min_authority_level
      - agents
    properties:
      mode:
        type: string
        enum: [none, org_wide, allowlist]
        description: none=no agent access; org_wide=all agents in org; allowlist=restricted list.
      min_authority_level:
        $ref: '#/$defs/authority_level'
        description: Minimum authority required for this operation (write/read).
      agents:
        $ref: '#/$defs/agent_selector'
        description: >-
          Agent allowlist for mode=allowlist. For mode=org_wide or none, keep empty.
      notes:
        type: string
        maxLength: 1000
    allOf:
      - if:
          properties:
            mode:
              enum: [org_wide, none]
        then:
          properties:
            agents:
              properties:
                agent_ids:
                  maxItems: 0
                agent_roles:
                  maxItems: 0
      - if:
          properties:
            mode:
              const: allowlist
        then:
          properties:
            agents:
              anyOf:
                - properties:
                    agent_ids:
                      minItems: 1
                - properties:
                    agent_roles:
                      minItems: 1

  agent_selector:
    type: object
    additionalProperties: false
    properties:
      agent_ids:
        type: array
        description: Explicit agent_id allowlist.
        items:
          type: string
          minLength: 3
          maxLength: 64
          pattern: '^[a-z](?:[a-z0-9-]{1,62}[a-z0-9])$'
      agent_roles:
        type: array
        description: Explicit agent role allowlist (role ids).
        items:
          $ref: '#/$defs/id_token'

  # --------
  # Versioning
  # --------
  versioning:
    type: object
    additionalProperties: false
    required:
      - revision
    description: Versioning metadata for updates and lineage.
    properties:
      revision:
        type: integer
        minimum: 1
        maximum: 1000000000
        description: Monotonic revision number for this memory_id.
      content_version:
        $ref: '#/$defs/semver'
        description: Optional semantic version for human-managed memory entries.
      supersedes_memory_ids:
        type: array
        description: Optional list of memory_ids that this entry supersedes.
        items:
          $ref: '#/$defs/memory_id'
      change_summary:
        type: string
        maxLength: 2000

  # --------
  # Timestamps
  # --------
  timestamps:
    type: object
    additionalProperties: false
    required:
      - created_at
      - updated_at
    properties:
      created_at:
        $ref: '#/$defs/date_time'
      updated_at:
        $ref: '#/$defs/date_time'

  # --------
  # Retention
  # --------
  retention:
    type: object
    additionalProperties: false
    required:
      - policy
    description: Retention and archival rules (enforced by storage/runtime).
    properties:
      policy:
        type: string
        enum: [retain, ttl_delete, ttl_archive]
      ttl_seconds:
        $ref: '#/$defs/positive_int'
        description: Required when policy is ttl_delete or ttl_archive.
      archive_location_ref:
        $ref: '#/$defs/uri_reference'
        description: Optional reference to an archive location/config (defined elsewhere).
      notes:
        type: string
        maxLength: 2000
    allOf:
      - if:
          properties:
            policy:
              enum: [ttl_delete, ttl_archive]
        then:
          required:
            - ttl_seconds

  # --------
  # Mutability
  # --------
  mutability:
    type: object
    additionalProperties: false
    required:
      - mode
    description: >-
      immutable: content never changes (new memory_id for changes).
      append_only: only append events/entries inside content (no rewrites).
      overwrite: content may be updated in place (revision must increment).
    properties:
      mode:
        type: string
        enum: [immutable, append_only, overwrite]
      notes:
        type: string
        maxLength: 1000

  # --------
  # Structure (optional chunking/summaries)
  # --------
  structure:
    type: object
    additionalProperties: false
    description: Optional structure metadata for chunked or summarized memory.
    properties:
      is_chunk:
        type: boolean
      parent_memory_id:
        $ref: '#/$defs/memory_id'
      chunk_index:
        $ref: '#/$defs/non_negative_int'
      chunk_count:
        $ref: '#/$defs/positive_int'
      is_summary:
        type: boolean
      notes:
        type: string
        maxLength: 1000
    allOf:
      - if:
          properties:
            is_chunk:
              const: true
        then:
          required:
            - parent_memory_id
            - chunk_index
            - chunk_count

  # --------
  # Invariants (constants)
  # --------
  invariants:
    type: object
    additionalProperties: false
    required:
      - org_scoped
      - injected_at_runtime
      - bulk_load_prohibited
      - raw_documents_are_not_memory
      - agents_only_see_structured_memory
      - promotion_requires_evaluation
      - promotion_allowed_authority_levels
      - workers_cannot_write_facts_or_procedures
      - side_effects_require_job_contract
    description: Platform-level invariants enforced as constants.
    properties:
      org_scoped:
        type: boolean
        const: true
        description: Memory is always scoped to exactly one organization.
      injected_at_runtime:
        type: boolean
        const: true
        description: Memory is injected at runtime, never bulk-loaded into an agent.
      bulk_load_prohibited:
        type: boolean
        const: true
      raw_documents_are_not_memory:
        type: boolean
        const: true
        description: Raw docs/transcripts/PDFs/websites must be stored as artifacts/sources, not memory.
      agents_only_see_structured_memory:
        type: boolean
        const: true
        description: Agents do not receive raw source material; only structured memory with references.
      promotion_requires_evaluation:
        type: boolean
        const: true
      promotion_allowed_authority_levels:
        type: array
        const: [org_lead, evaluator]
        description: Only these authority levels may promote to authoritative.
      workers_cannot_write_facts_or_procedures:
        type: boolean
        const: true
      side_effects_require_job_contract:
        type: boolean
        const: true
        description: Any state mutation must be performed under an explicit job contract (referenced elsewhere).

  # --------
  # Content schemas per type
  # --------
  content_facts:
    type: object
    additionalProperties: false
    required:
      - statement
    properties:
      statement:
        type: string
        minLength: 1
        maxLength: 1000
        description: Canonical fact statement in plain language.
      keys:
        type: array
        description: Optional deterministic lookup keys for this fact.
        items:
          $ref: '#/$defs/id_token'
      attributes:
        type: object
        additionalProperties:
          $ref: '#/$defs/attribute_value'
        description: Optional structured attributes for the fact (bounded to safe JSON primitives).
      validity:
        type: object
        additionalProperties: false
        properties:
          valid_from:
            $ref: '#/$defs/date_time'
          valid_to:
            $ref: '#/$defs/date_time'

  attribute_value:
    description: A safe, bounded JSON value for structured attributes.
    oneOf:
      - type: string
        maxLength: 500
      - type: number
      - type: boolean
      - type: 'null'
      - type: array
        maxItems: 32
        items:
          oneOf:
            - type: string
              maxLength: 200
            - type: number
            - type: boolean
            - type: 'null'

  content_procedures:
    type: object
    additionalProperties: false
    required:
      - goal
      - steps
    properties:
      goal:
        type: string
        minLength: 1
        maxLength: 500
        description: What this procedure achieves.
      steps:
        type: array
        minItems: 1
        description: Ordered procedure steps (plain language, tool-agnostic).
        items:
          $ref: '#/$defs/procedure_step'
      inputs:
        type: array
        description: Optional inputs required to execute the procedure (plain language).
        items:
          type: string
          minLength: 1
          maxLength: 200
      outputs:
        type: array
        description: Optional outputs produced by executing the procedure (plain language).
        items:
          type: string
          minLength: 1
          maxLength: 200

  procedure_step:
    type: object
    additionalProperties: false
    required:
      - step_id
      - instruction
    properties:
      step_id:
        $ref: '#/$defs/id_token'
      instruction:
        type: string
        minLength: 1
        maxLength: 1000
      notes:
        type: string
        maxLength: 1000

  content_templates:
    type: object
    additionalProperties: false
    required:
      - template_format
      - body
    properties:
      template_format:
        type: string
        enum: [text, markdown, html, json, yaml]
        description: Template payload format.
      body:
        type: string
        minLength: 1
        maxLength: 20000
        description: Template body. Keep templates concise; do not embed raw documents.
      placeholders:
        type: array
        description: Optional placeholder identifiers expected in the template body.
        items:
          $ref: '#/$defs/id_token'

  content_examples:
    type: object
    additionalProperties: false
    required:
      - description
      - example
    properties:
      description:
        type: string
        minLength: 1
        maxLength: 2000
        description: What this example demonstrates.
      example:
        $ref: '#/$defs/io_example'

  io_example:
    type: object
    additionalProperties: false
    required:
      - input
      - output
    description: >-
      Example input/output pair. Intended for small, structured examples, not raw
      documents.
    properties:
      input:
        $ref: '#/$defs/json_value'
      output:
        $ref: '#/$defs/json_value'

  json_value:
    description: A JSON value (bounded for safety).
    oneOf:
      - type: object
        additionalProperties: true
        maxProperties: 200
      - type: array
        maxItems: 200
        items: {}
      - type: string
        maxLength: 20000
      - type: number
      - type: boolean
      - type: 'null'

  content_decisions:
    type: object
    additionalProperties: false
    required:
      - question
      - chosen_option
      - rationale
    properties:
      question:
        type: string
        minLength: 1
        maxLength: 1000
        description: Decision question or problem statement.
      chosen_option:
        type: string
        minLength: 1
        maxLength: 2000
        description: The chosen option/decision (plain language).
      rationale:
        type: string
        minLength: 1
        maxLength: 4000
        description: Why this decision was chosen.
      options_considered:
        type: array
        description: Optional alternatives and tradeoffs.
        items:
          $ref: '#/$defs/decision_option'
      constraints:
        type: array
        description: Optional constraints applied to the decision.
        items:
          type: string
          minLength: 1
          maxLength: 500

  decision_option:
    type: object
    additionalProperties: false
    required:
      - option_id
      - description
    properties:
      option_id:
        $ref: '#/$defs/id_token'
      description:
        type: string
        minLength: 1
        maxLength: 1000
      pros:
        type: array
        items:
          type: string
          minLength: 1
          maxLength: 300
      cons:
        type: array
        items:
          type: string
          minLength: 1
          maxLength: 300

  content_artifacts:
    type: object
    additionalProperties: false
    required:
      - artifacts
    description: >-
      Memory entries may reference artifacts, but artifacts themselves are not
      defined here. This is for deterministic retrieval and provenance.
    properties:
      artifacts:
        type: array
        minItems: 1
        items:
          $ref: '#/$defs/artifact_ref'
      summary:
        type: string
        maxLength: 2000

  artifact_ref:
    type: object
    additionalProperties: false
    required:
      - artifact_id
      - artifact_type_id
      - ref
    properties:
      artifact_id:
        type: string
        minLength: 1
        maxLength: 128
        pattern: '^[A-Za-z0-9][A-Za-z0-9_.:-]{0,127}$'
        description: Artifact identifier (defined elsewhere).
      artifact_type_id:
        $ref: '#/$defs/id_token'
        description: Artifact type identifier (defined elsewhere).
      ref:
        $ref: '#/$defs/uri_reference'
        description: Reference to the artifact record or schema (defined elsewhere).
      notes:
        type: string
        maxLength: 1000

  content_notes:
    type: object
    additionalProperties: false
    required:
      - text
    description: Optional low-authority notes. Not eligible for authoritative status.
    properties:
      format:
        type: string
        enum: [text, markdown]
        default: text
      text:
        type: string
        minLength: 1
        maxLength: 20000
